---
title: "R Notebook"
output: html_notebook
---

```{r Loaded Packages}
library(knitr)
library(brms)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
```



Jumping in to the zero inflated models. Some helpful stuff here has been [_How to analyze visual analog (slider) scale data?_](https://mvuorre.github.io/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/) by Matti Vuorre. 

Following what he has done, specify a `bf()`. Here we are using regions as the grouping factor, just to get things going. I've specified no priors here. Getting things running is the goal here. 
```{r 8 region ZIB}
zi_bf1 <- 
  bf(
  irrfrac ~ eight_regions,
  phi ~ eight_regions,
  zi ~ eight_regions,
  family = zero_inflated_beta()
)

zi1 <- brm(
  formula = zi_bf1,
  data = aei,
  cores = 4,
  seed = 17,
  file = "/Volumes/RachelExternal/Thesis/Thesis/fits/zi_1"
)

print(zi1)
```

This took about an hour to run and `There were 1053 transitions after warmup that exceeded the maximum treedepth`. LaLala.... Deal with this later. 

```{r}
mcmc_plot(zi1, type = "neff")
```


All of the summary output is transformed via the logit ($\mu, zi$) or log ($\phi$) link. We need to transform them in to the response scale, use `exp` to transform $\phi$ and `plogis` for $\mu$ and $zi$ to be able to interpret them better. I am assuming that all parameters that are $\phi$ related have the same  log link and need to be transformed via `exp` and others need`plogis` as they use the logit link. Is this a fair assumption?

```{r}
posterior_samples(zi1, pars = "b_")[,1:24] %>% 
  #the old fashioned way, brute force.
  mutate_at(c("b_phi_Intercept", "b_phi_eight_regionsafrica_sub_saharan", 
              "b_phi_eight_regionsamerica_north", 
              "b_phi_eight_regionsamerica_north",
              "b_phi_eight_regionsasia_west", 
              "b_phi_eight_regionseast_asia_pacific",
              "b_phi_eight_regionseurope_east", 
              "b_phi_eight_regionseurope_west"), exp) %>% 
  mutate_at(vars(-c("b_phi_Intercept", "b_phi_eight_regionsafrica_sub_saharan", 
              "b_phi_eight_regionsamerica_north", 
              "b_phi_eight_regionsamerica_north",
              "b_phi_eight_regionsasia_west", 
              "b_phi_eight_regionseast_asia_pacific",
              "b_phi_eight_regionseurope_east", 
              "b_phi_eight_regionseurope_west")), plogis) %>% 
  posterior_summary() %>% 
  as.data.frame() %>% 
  rownames_to_column("Parameter") %>% 
  kable(digits = 2) 
```
Again, one region is encapsulated by the population level Intercept, zi_intercept, and phi_intercept. 

```{r}
plot(
  conditional_effects(zi1, dpar = "mu"), 
  points = TRUE, 
  point_args = list(width = .05, shape = 1)
)
```


```{r}
zi_bf2 <- 
  bf(
  irrfrac ~ four_regions,
  phi ~ four_regions,
  zi ~ four_regions,
  family = zero_inflated_beta()
)
```


Now run a model.
```{r}
zi2 <- brm(
  formula = zi_bf2,
  data = aei,
  cores = 4,
  seed = 17,
  control = list(adapt_delta = 0.99), #see if this decreases divergent trans
  file = "/Volumes/RachelExternal/Thesis/Thesis/fits/zi_2"
)
```
```{r}
print(zi2)
```


```{r}
posterior_samples(zi2, pars = "b_")[,1:12] %>% 
  #the old fashioned way, brute force.
  mutate_at(c("b_phi_Intercept", "b_phi_four_regionsamericas", 
              "b_phi_four_regionsasia", 
              "b_phi_four_regionseurope"), exp) %>% 
  mutate_at(vars(-c("b_phi_Intercept", "b_phi_four_regionsamericas", 
              "b_phi_four_regionsasia", 
              "b_phi_four_regionseurope")), plogis) %>% 
  posterior_summary() %>% 
  as.data.frame() %>% 
  rownames_to_column("Parameter") %>% 
  kable(digits = 2) 

```

```{r}
plot(
  conditional_effects(zi2, dpar = "mu"), 
  points = TRUE, 
  point_args = list(width = .05, shape = 1)
)
```
```{r}
pp_check(zi1)
pp_check(zi2)
```
Loooovvvveee it. Look at that!
